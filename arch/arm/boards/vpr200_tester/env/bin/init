#!/bin/sh

PATH=/env/bin
export PATH

. /env/config

# leds off
i2c_write -a 0x08 -r 0x35 0x00 0x00 0x00 
i2c_write -a 0x08 -r 0x36 0x00 0x00 0x00 

echo "PMIC led should be flashing white"
i2c_write -a 0x08 -r 0x35 0x8a 0xd8 0xad
i2c_write -a 0x08 -r 0x36 0x00 0x08 0xad

HASERROR="0"
export HASERROR

echo "Testing VPR GPIO & LED"
vpr_test

if [ x$? != x0 ]; then
	# solid red
	i2c_write -a 0x08 -r 0x35 0x00 0x09 0xfd
	i2c_write -a 0x08 -r 0x36 0x00 0x00 0x00 
	echo "Error testing GPIO"
	HASERROR="1"

	sleep 5
fi

# leds off
i2c_write -a 0x08 -r 0x35 0x00 0x00 0x00 
i2c_write -a 0x08 -r 0x36 0x00 0x00 0x00 

# memory test
/env/bin/test_mem
if [ x$? != x0 ]; then
	echo "Error testing MEM"
	HASERROR="1"
fi


/env/bin/test_eeprom
if [ x$? != x0 ]; then
	echo "Error testing EEPROM"
	HASERROR="1"
fi

/env/bin/test_devices
if [ x$? != x0 ]; then
	echo "Error testing DEVICES"
	HASERROR="1"
fi

echo Tests finished
echo $HASERROR
if [ x$HASERROR = x0 ]; then
	#solid green
	i2c_write -a 0x08 -r 0x35 0x9f 0xd0 0x00 
	i2c_write -a 0x08 -r 0x36 0x00 0x00 0x00
	echo "All good."
else
	#solid red
	i2c_write -a 0x08 -r 0x35 0x00 0x09 0xfd
	i2c_write -a 0x08 -r 0x36 0x00 0x00 0x00 
	echo "Something FAILED"
	devinfo
	dump_clocks
	mc13xxx_dump
fi
